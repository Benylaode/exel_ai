<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Alam</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for general text (though app specifies serif, this is a common fallback) -->
    <!-- For serif font, you might want to link a specific serif font like Merriweather or Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Merriweather as the serif font */
        body {
            font-family: 'Merriweather', serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for JSX transformation in browser (for development only) -->
    <!-- In a production environment, you would use a build tool like Webpack/Vite to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSX library (already included in your App.jsx, but better to ensure it's loaded before App) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="text/babel">
        // This is where your App.jsx content would go.
        // For this example, we'll assume App.jsx content is directly here.
        // In a real project, you would import App from './App.jsx';

        // Your App.jsx code starts here
        const App = () => {
            const [workbook, setWorkbook] = React.useState(null);
            const [sheetNames, setSheetNames] = React.useState([]);
            const [activeSheetName, setActiveSheetName] = React.useState('');
            const [sheetData, setSheetData] = React.useState([]);
            const [message, setMessage] = React.useState('');
            const fileInputRef = React.useRef(null);

            const [showAIPromptModal, setShowAIPromptModal] = React.useState(false);
            const [aiPrompt, setAiPrompt] = React.useState('');
            const [isGeneratingAI, setIsGeneratingAI] = React.useState(false);

            React.useEffect(() => {
                if (workbook && activeSheetName) {
                    if (typeof XLSX !== 'undefined' && XLSX.utils) {
                        const ws = workbook.Sheets[activeSheetName];
                        const jsonSheetData = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
                        setSheetData(jsonSheetData);
                    } else {
                        setMessage('Pustaka XLSX belum dimuat. Harap segarkan halaman.');
                    }
                }
            }, [workbook, activeSheetName]);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    setMessage('Tidak ada file yang dipilih.');
                    return;
                }

                if (typeof XLSX === 'undefined' || !XLSX.read) {
                    setMessage('Pustaka XLSX belum dimuat. Harap segarkan halaman atau coba lagi.');
                    return;
                }

                setMessage('Mengunggah dan memproses file...');
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        setWorkbook(wb);
                        setSheetNames(wb.SheetNames);
                        if (wb.SheetNames.length > 0) {
                            setActiveSheetName(wb.SheetNames[0]);
                            setMessage(`File "${file.name}" berhasil diunggah. Memuat sheet pertama.`);
                        } else {
                            setMessage('File Excel tidak memiliki sheet.');
                            setSheetData([]);
                        }
                    } catch (error) {
                        console.error('Error reading Excel file:', error);
                        setMessage('Gagal membaca file Excel. Pastikan formatnya benar.');
                        setWorkbook(null);
                        setSheetNames([]);
                        setActiveSheetName('');
                        setSheetData([]);
                    }
                };

                reader.onerror = () => {
                    setMessage('Gagal membaca file.');
                    setWorkbook(null);
                    setSheetNames([]);
                    setActiveSheetName('');
                    setSheetData([]);
                };

                reader.readAsArrayBuffer(file);
            };

            const handleSheetChange = (sheetName) => {
                setActiveSheetName(sheetName);
                setMessage(`Beralih ke sheet: ${sheetName}`);
            };

            const handleCellChange = (rowIndex, colIndex, value) => {
                const newSheetData = [...sheetData];
                if (!newSheetData[rowIndex]) {
                    newSheetData[rowIndex] = [];
                }
                newSheetData[rowIndex][colIndex] = value;
                setSheetData(newSheetData);

                if (workbook && activeSheetName && typeof XLSX !== 'undefined' && XLSX.utils) {
                    const ws = XLSX.utils.aoa_to_sheet(newSheetData);
                    workbook.Sheets[activeSheetName] = ws;
                }
            };

            const handleAddRow = (content = null) => {
                const newSheetData = [...sheetData];
                const numCols = newSheetData.length > 0 ? Math.max(...newSheetData.map(row => row.length)) : 5;
                const newRow = Array(numCols).fill('');

                if (content !== null) {
                    newRow[0] = content;
                }

                newSheetData.push(newRow);
                setSheetData(newSheetData);

                if (workbook && activeSheetName && typeof XLSX !== 'undefined' && XLSX.utils) {
                    const ws = XLSX.utils.aoa_to_sheet(newSheetData);
                    workbook.Sheets[activeSheetName] = ws;
                    setMessage(content ? 'Baris baru dengan konten AI ditambahkan.' : 'Baris baru ditambahkan.');
                }
            };

            const handleCalculateTotals = () => {
                if (!sheetData || sheetData.length < 1) {
                    setMessage('Tidak ada data untuk dihitung total.');
                    return;
                }

                const headerRow = sheetData[0];
                const dataRows = sheetData.slice(1);

                const totals = Array(headerRow.length).fill('');

                headerRow.forEach((header, colIndex) => {
                    let isNumericColumn = true;
                    let sum = 0;
                    dataRows.forEach(row => {
                        const cellValue = row[colIndex];
                        const numericValue = parseFloat(cellValue);
                        if (!isNaN(numericValue) && cellValue !== '' && cellValue !== null && cellValue !== undefined) {
                            sum += numericValue;
                        } else if (cellValue !== '' && cellValue !== null && cellValue !== undefined) {
                            isNumericColumn = false;
                        }
                    });

                    if (isNumericColumn) {
                        totals[colIndex] = sum;
                    }
                });

                const newSheetData = [...sheetData];
                let totalRowIndex = -1;

                for (let i = 0; i < newSheetData.length; i++) {
                    if (typeof newSheetData[i][0] === 'string' && (newSheetData[i][0].toLowerCase() === 'total' || newSheetData[i][0].toLowerCase() === 'jumlah')) {
                        totalRowIndex = i;
                        break;
                    }
                }

                const totalRow = ['Total', ...totals.slice(1)];

                if (totalRowIndex !== -1) {
                    newSheetData[totalRowIndex] = totalRow;
                } else {
                    newSheetData.push(totalRow);
                }

                setSheetData(newSheetData);

                if (workbook && activeSheetName && typeof XLSX !== 'undefined' && XLSX.utils) {
                    const ws = XLSX.utils.aoa_to_sheet(newSheetData);
                    workbook.Sheets[activeSheetName] = ws;
                    setMessage('Total kolom dihitung dan ditambahkan.');
                }
            };

            const handleGenerateAIContent = async () => {
                if (!aiPrompt.trim()) {
                    setMessage('Mohon masukkan prompt untuk AI.');
                    return;
                }
                if (!workbook || !activeSheetName) {
                    setMessage('Harap unggah file Excel terlebih dahulu.');
                    return;
                }

                setIsGeneratingAI(true);
                setMessage('Menghasilkan konten AI...');

                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: aiPrompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        handleAddRow(text);
                        setMessage('Konten AI berhasil dihasilkan dan ditambahkan.');
                    } else {
                        setMessage('Gagal menghasilkan konten AI. Coba lagi.');
                        console.error('Unexpected AI response structure:', result);
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    setMessage('Terjadi kesalahan saat menghubungi AI. Mohon coba lagi.');
                } finally {
                    setIsGeneratingAI(false);
                    setShowAIPromptModal(false);
                    setAiPrompt('');
                }
            };

            const handleDownload = () => {
                if (!workbook) {
                    setMessage('Tidak ada file Excel untuk diunduh.');
                    return;
                }

                if (typeof XLSX === 'undefined' || !XLSX.utils || !XLSX.writeFile) {
                    setMessage('Pustaka XLSX belum dimuat. Harap segarkan halaman atau coba lagi.');
                    return;
                }

                try {
                    const wb = XLSX.utils.book_new();
                    sheetNames.forEach(sheetName => {
                        let ws;
                        if (sheetName === activeSheetName) {
                            ws = XLSX.utils.aoa_to_sheet(sheetData);
                        } else {
                            ws = workbook.Sheets[sheetName];
                        }
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    });

                    XLSX.writeFile(wb, 'modified_spreadsheet.xlsx');
                    setMessage('File Excel berhasil diunduh.');
                } catch (error) {
                    console.error('Error downloading Excel file:', error);
                    setMessage('Gagal mengunduh file Excel.');
                }
            };

            return (
                <div className="min-h-screen flex flex-col font-serif bg-gradient-to-br from-green-50 to-green-200">
                    {/* Header Section */}
                    <header className="bg-green-800 text-white p-4 shadow-md">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-2xl sm:text-3xl font-bold">ðŸŒ¿ Spreadsheet Alam</h1>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-grow flex flex-col items-center p-4">
                        <div className="bg-green-100 p-6 rounded-xl shadow-lg w-full max-w-4xl border border-green-300">
                            <h2 className="text-2xl font-bold text-center text-green-800 mb-6">Editor Spreadsheet Interaktif</h2>

                            <div className="mb-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                                <input
                                    type="file"
                                    accept=".xlsx, .xls"
                                    onChange={handleFileUpload}
                                    ref={fileInputRef}
                                    className="hidden"
                                />
                                <button
                                    onClick={() => fileInputRef.current.click()}
                                    className="px-6 py-3 bg-green-700 text-white font-semibold rounded-lg shadow-md hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-75 transition duration-300 ease-in-out"
                                >
                                    Unggah File Excel
                                </button>

                                {workbook && (
                                    <>
                                        <button
                                            onClick={handleAddRow}
                                            className="px-6 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-75 transition duration-300 ease-in-out"
                                        >
                                            Tambah Baris
                                        </button>
                                        <button
                                            onClick={handleCalculateTotals}
                                            className="px-6 py-3 bg-lime-600 text-white font-semibold rounded-lg shadow-md hover:bg-lime-700 focus:outline-none focus:ring-2 focus:ring-lime-500 focus:ring-opacity-75 transition duration-300 ease-in-out"
                                        >
                                            Hitung Semua Total
                                        </button>
                                        <button
                                            onClick={() => setShowAIPromptModal(true)}
                                            className="px-6 py-3 bg-amber-600 text-white font-semibold rounded-lg shadow-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-75 transition duration-300 ease-in-out"
                                        >
                                            Hasilkan Konten AI
                                        </button>
                                        <button
                                            onClick={handleDownload}
                                            className="px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75 transition duration-300 ease-in-out"
                                        >
                                            Unduh Excel
                                        </button>
                                    </>
                                )}
                            </div>

                            {message && (
                                <p className="text-center text-green-700 mb-4">{message}</p>
                            )}

                            {sheetNames.length > 1 && (
                                <div className="mb-4 flex flex-wrap justify-center gap-2">
                                    {sheetNames.map((name) => (
                                        <button
                                            key={name}
                                            onClick={() => handleSheetChange(name)}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition duration-300 ease-in-out ${
                                                activeSheetName === name
                                                    ? 'bg-green-600 text-white shadow-md'
                                                    : 'bg-green-200 text-green-800 hover:bg-green-300'
                                            }`}
                                        >
                                            {name}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {sheetData.length > 0 && (
                                <div className="overflow-x-auto rounded-lg border border-green-300 shadow-sm">
                                    <table className="min-w-full divide-y divide-green-200 bg-white">
                                        <thead className="bg-green-50">
                                            <tr>
                                                {sheetData[0] && sheetData[0].map((header, index) => (
                                                    <th
                                                        key={index}
                                                        className="px-4 py-2 text-left text-xs font-medium text-green-700 uppercase tracking-wider"
                                                    >
                                                        {header}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-green-200">
                                            {sheetData.slice(1).map((row, rowIndex) => (
                                                <tr key={rowIndex} className="hover:bg-green-50">
                                                    {row.map((cell, colIndex) => (
                                                        <td key={colIndex} className="px-4 py-2 whitespace-nowrap">
                                                            <input
                                                                type="text"
                                                                value={cell !== null && cell !== undefined ? cell : ''}
                                                                onChange={(e) => handleCellChange(rowIndex + 1, colIndex, e.target.value)}
                                                                className="w-full border border-green-300 rounded-md px-2 py-1 text-sm text-gray-900 focus:ring-green-500 focus:border-green-500"
                                                            />
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Footer Section */}
                    <footer className="bg-green-800 text-white p-4 mt-8">
                        <div className="container mx-auto text-center text-sm">
                            <p>&copy; {new Date().getFullYear()} Spreadsheet Alam. Hak Cipta Dilindungi.</p>
                            <p>Dibuat dengan sentuhan alam dan AI.</p>
                        </div>
                    </footer>

                    {/* AI Prompt Modal */}
                    {showAIPromptModal && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-green-100 p-6 rounded-xl shadow-lg w-full max-w-md border border-green-300">
                                <h2 className="text-2xl font-bold text-green-800 mb-4">Hasilkan Konten dengan AI</h2>
                                <textarea
                                    className="w-full p-3 border border-green-300 rounded-lg mb-4 focus:ring-green-500 focus:border-green-500 text-gray-800"
                                    rows="4"
                                    placeholder="Masukkan prompt Anda di sini (misalnya: 'Daftar 5 ide produk baru untuk startup teknologi')"
                                    value={aiPrompt}
                                    onChange={(e) => setAiPrompt(e.target.value)}
                                    disabled={isGeneratingAI}
                                ></textarea>
                                <div className="flex justify-end gap-3">
                                    <button
                                        onClick={() => setShowAIPromptModal(false)}
                                        className="px-5 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300"
                                        disabled={isGeneratingAI}
                                    >
                                        Batal
                                    </button>
                                    <button
                                        onClick={handleGenerateAIContent}
                                        className="px-5 py-2 bg-green-700 text-white font-semibold rounded-lg shadow-md hover:bg-green-800 transition duration-300"
                                        disabled={isGeneratingAI}
                                    >
                                        {isGeneratingAI ? (
                                            <svg className="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        ) : (
                                            'Hasilkan'
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the App component into the root div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
